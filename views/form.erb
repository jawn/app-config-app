<% content_for :title do "Config Form" end %>

<script type="text/javascript">
//<![CDATA[

    angular.module("appcfg", ["ngResource"]).factory("AppCfgModel", function ($resource) {
        return $resource("/<%= cfg_form %>");
    });

    function AppCfg($scope, $http, AppCfgModel) {
        $scope.cfg = AppCfgModel.get();

        $scope.updateDigest = function () {
            $http.get("/<%= cfg_form.sub /json$/, 'md5' %>").success(function (response) {
                $scope.digest = response;
            });
        };

        $scope.change = function () {
            $scope.cfg.$save(function () {
                $scope.changed = false;
                $scope.updateDigest();
                $scope.hasChanges();
            }, function () {
                alert("Error occurred during save.");
                $scope.changed = false;
            });
        };

        $scope.hasChanges = function () {
            $http.get("/<%= cfg_form.sub /json$/, 'changed' %>").success(function (response) {
                $scope.changesFlag = (response == "true") ? "*" : "";
            });
        };

        $scope.diffs = function () {
            $http.get("/<%= cfg_form.sub /json$/, 'diffs' %>").success(function (response) {
                $scope.statusMessage = response;
            }).failure(function () {
                $scope.statusMessage = "";
                alert("Diff failed");
            });
        };

        $scope.revert = function () {
            if (confirm("Are you sure?\nYou will lose any changes.")) {
                $http.post("/revert/<%= cfg_form %>").success(function (response) {
                    $scope.changesFlag = "";
                    $scope.cfg.$get({}, function () {
                        $scope.statusMessage = response;
                    },  function (code, response) {
                        $scope.statusMessage = "";
                        alert("Revert succeeded, reload failed");
                    });
                }).failure(function (response) {
                    $scope.statusMessage = "";
                    alert("Revert failed");
                });
            }
        };

        $scope.addListItem = function (list, item) {
            list.push(item);
            $scope.change();
        };

        $scope.removeListItem = function (list, item) {
            var newList = [];
            while (list.length > 0) {
                var n = list.pop();
                if (n != item) {
                    newList.push(n);
                }
            }
            while (newList.length > 0) {
                list.push(newList.pop());
            }
            $scope.change();
        };

        $scope.updateDigest();
        $scope.hasChanges();

        <%= js %>
    }

//]]>
</script>

<div data-ng-app="appcfg" data-ng-controller="AppCfg" id="config-form">
    <div >
      <div style="float: left; font-size: 16px;"><%= cfg_form %></div>
      <div style="float: right;">
        <span>{{digest}}</span>
        <span style="color: red;">{{changesFlag}}</span>
      </div>
      <div style="clear: both;"/>
    </div>

        <a href="/<%= cfg_form %>">Raw JSON</a></p>
    <%= form %>
    <p>
        <button data-ng-click="diffs()">View Diff</button>
        <button data-ng-click="revert()">Revert</button>
    </p>
    <div id="status_message" data-ng-bind-html-unsafe="statusMessage"></div>
</div>
