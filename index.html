<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xmlns:ng="http://angularjs.org">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Configuration application (alpha)</title>
  <script type="text/javascript" ng:autobind src="http://code.angularjs.org/0.9.19/angular-0.9.19.min.js"></script>
</head>
<body ng:controller="AppCfg">
  
<script type="text/javascript">

    function AppCfg($resource, $xhr) {		
      var self = this;
	  this.newNickname = "";
	  this.statusMessage;
	  this.message;
      this.cfg = $resource("stack_configuration.json").get({});
    
      this.save = function() {
        self.cfg.$save(function() {
          alert('config saved to server');
        }, function() {
          alert('ERROR on save');
        });
      };

	  this.diffs = function() {		  
		  $xhr("get", "/diffs/stack_configuration.json", function(code, serverMessage) {
		      self.statusMessage = serverMessage;
		  }, function(code, response) {
		     alert("Diff failed");
		  });		    	
	  };
	  
	  this.commit = function() {		  
		  $xhr("post", "/commit?message=" + self.message, function(code, serverMessage) {
		      self.statusMessage = serverMessage;
		  }, function(code, response) {
		     alert("git commit failed");
		  });		    	
	  };
	  
	  this.sync = function() {
		  $xhr("post", "/sync", function(code, svrMessage) {
		      self.statusMessage = svrMessage;
		  }, function(code, response) {
		     alert("Sync failed");
		  });		    	
	  };
          
          this.revert = function() {              
                  $xhr("post", "/revert/stack_configuration.json", function(code, serverMessage) {
                      self.cfg.$get({}, function() {
                          self.statusMessage = serverMessage;
                      }, function(code, response) {
                          alert("Revert succeeded, reload failed");
                      });
                  }, function(code, response) {
                     alert("Revert failed");
                  });
          };
	  
      this.newNick = function() {
        self.cfg.bannedNicks.push(self.newNickname);
		self.newNickname = "";
      };	  
	  
      this.deleteNick = function(nick) {
	      var oldBannedNicks = self.cfg.bannedNicks;
	      self.cfg.bannedNicks = [];
	      angular.forEach(oldBannedNicks, function(n) {
	        if (nick != n) self.cfg.bannedNicks.push(n);
	      });
      };	  	  
	    	  
    }

    AppCfg.$inject = ["$resource", "$xhr"];
    	
</script>  

  Light is on:  <input type="checkbox" name="cfg.lighton"> <br/>
  
  Default Error Reciever (email): <input name="cfg.defaultErrorReciever" ng:validate="email"/> <br/>
  
  Max Load Percentage: <input name="cfg.loadMaxPercent" ng:validate="number:0:100"/> <br/>
  
  Next Shutdown Date: <input name="cfg.nextShutdownDate" ng:validate="date"/> <br/>
  
  Banned nicks: 
      <ol>
	      <li ng:repeat="nick in cfg.bannedNicks"><span>{{nick}}&nbsp;&nbsp;<a ng:click="deleteNick(nick)">[X]</a></span></li>
	  </ol>
  <form ng:submit="newNick()">
    <input type="text" name="newNickname" size="20">
    <input type="submit" value="&lt;-- Add Nick"><br>
  </form>	  
  
  <hr/>
  
  <button ng:click="save()">Save Changes</button><br/>
  <button ng:click="diffs()">Show Diffs</button><br/>
  <button ng:click="revert()">Revert Changes</button><br/>
  <button ng:disabled="{{!message}}" ng:click="commit()">Commit Changes</button> Commit Message: <input name="message"></input><br/> 
  <button ng:click="sync()">Sync Working Copy</button><br/><br/>

  <div ng:bind="statusMessage | html:'unsafe'"></div>
  
</body>


</html>

